<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Wordle Solver Visualizer</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { background: #f3f4f6; }
        .tile {
            width: 45px; height: 45px;
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; font-size: 1.3rem;
            margin: 3px; border-radius: 6px;
        }
        .B { background: #787c7e; color: white; }
        .Y { background: #c9b458; color: white; }
        .G { background: #6aaa64; color: white; }
    </style>
</head>

<body class="p-10 flex flex-col items-center">

    <h1 class="text-4xl font-bold mb-6">üîç Wordle Solver Visualizer</h1>

    <div class="flex gap-4 mb-6">
        <button id="dailyBtn" class="px-5 py-3 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition">
            üü¶ Daily Wordle
        </button>
        <button id="randomBtn" class="px-5 py-3 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition">
            üü© Random Wordle
        </button>
        <button id="solveBtn" class="px-5 py-3 bg-purple-600 text-white rounded-lg shadow hover:bg-purple-700 transition">
            ‚ñ∂ Solve
        </button>
    </div>

    <p id="currentWord" class="mb-2 text-gray-700 font-medium">Mot choisi: ‚Ä¶</p>
    <p id="timer" class="mb-4 text-gray-700 font-medium">Temps √©coul√©: 0.00 s</p>
    <div id="output" class="mt-4 w-full max-w-xl space-y-6"></div>

    <!-- Config JS pour port backend dynamique -->
    <script src="config.js"></script>

    <script>
    let currentWordType = null; // 'daily' ou 'random'
    let currentWord = null;
    let eventSource = null;

    let startTime = null;
    let timerInterval = null;

    async function fetchWord(type) {
        // üîπ Ferme le flux SSE si existant
        if (eventSource) {
            eventSource.close();
            eventSource = null;
        }

        // üîπ R√©initialise l'affichage des √©tapes
        document.getElementById("output").innerHTML = "";

        // üîπ R√©initialise le chrono
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        startTime = null;
        document.getElementById("timer").textContent = "Temps √©coul√©: 0.00 s";

        // üîπ R√©cup√®re le mot depuis le backend
        const url = type === 'daily'
            ? `${API_HOST}/word-of-the-day`
            : `${API_HOST}/random-word`;

        const res = await fetch(url);
        const data = await res.json();

        currentWordType = type;
        currentWord = data.word;

        document.getElementById("currentWord").textContent =
            "Mot choisi: " + currentWord;
    }

    function startTimer() {
        startTime = performance.now();
        document.getElementById("timer").textContent = "Temps √©coul√©: 0.00 s";

        timerInterval = setInterval(() => {
            const elapsed = (performance.now() - startTime) / 1000;
            document.getElementById("timer").textContent = `Temps √©coul√©: ${elapsed.toFixed(2)} s`;
        }, 50);
    }

    function stopTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        if (startTime !== null) {
            const elapsed = (performance.now() - startTime) / 1000;
            document.getElementById("timer").textContent = `Temps final: ${elapsed.toFixed(2)} s`;
            startTime = null;
        }
    }

    function runSolver() {
        if (!currentWordType) {
            alert("Veuillez d'abord choisir Daily ou Random Wordle.");
            return;
        }

        startTimer(); // üîπ D√©marre le chrono

        const output = document.getElementById("output");
        output.innerHTML = "";

        if (eventSource) eventSource.close();

        const url = currentWordType === "daily"
            ? `${API_HOST}/run-daily`
            : `${API_HOST}/run-random`;

        eventSource = new EventSource(url);

        eventSource.onmessage = (event) => {
            const step = JSON.parse(event.data);

            const row = document.createElement("div");
            row.className = "p-4 bg-white shadow rounded-lg";

            row.innerHTML = `
                <h2 class="font-bold text-lg mb-2">√âtape ${step.step}</h2>
                <div class="flex mb-3">
                    ${step.guess.split("").map((c,i) =>
                        `<div class="tile ${step.feedback[i]}">${c.toUpperCase()}</div>`
                    ).join("")}
                </div>
                <p class="text-gray-600">Feedback : <b>${step.feedback}</b></p>
            `;

            output.appendChild(row);

            if (step.feedback === "GGGGG") {
                stopTimer();
                eventSource.close();
            }
        };

        eventSource.onerror = () => {
            if (eventSource.readyState === EventSource.CLOSED) return;
            console.error("Erreur SSE r√©elle");
            stopTimer();
            eventSource.close();
        };
    }

    document.getElementById("dailyBtn").onclick = () => fetchWord("daily");
    document.getElementById("randomBtn").onclick = () => fetchWord("random");
    document.getElementById("solveBtn").onclick = runSolver;

    // Auto-load daily word
    fetchWord("daily");
    </script>
</body>
</html>
